worker_processes auto;
error_log stderr warn;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    # Treat files with unknown filetype as binary
    default_type application/octet-stream;

    # Define custom log format to include response times
    log_format main_timed '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for" '
                          '$request_time $upstream_response_time $pipe';

    access_log /dev/stdout main_timed;
    error_log /dev/stderr notice;

    keepalive_timeout 65;

    # Write temporary files to /tmp so they can be created as a non-privileged user
    client_body_temp_path /tmp/client_temp;
    proxy_temp_path /tmp/proxy_temp_path;
    fastcgi_temp_path /tmp/fastcgi_temp;
    uwsgi_temp_path /tmp/uwsgi_temp;
    scgi_temp_path /tmp/scgi_temp;

    # Hide headers that identify the server to prevent information leakage
    proxy_hide_header X-Powered-By;
    fastcgi_hide_header X-Powered-By;
    server_tokens off;

    # Compression is occurring on HAProxy
    gzip off;

    # Laravel server configuration
    server {
        listen 80 reuseport;
        listen [::]:80 reuseport;
        server_name _;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        absolute_redirect off;

        root /var/www/html/public;
        index index.php index.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Trust HAProxy for real IP forwarding
        set_real_ip_from 0.0.0.0/0;
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;

        # Max upload size
        client_max_body_size 10M;

        # Laravel front controller pattern
        location / {
            try_files $uri $uri/ /index.php?$query_string;

            # NO PHP caching for authenticated application
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
        }

        # Disable logging for common files
        location = /favicon.ico {
            access_log off;
            log_not_found off;
        }

        location = /robots.txt {
            access_log off;
            log_not_found off;
        }

        # PHP-FPM configuration
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;

            # Forward real IP and protocol from HAProxy
            fastcgi_param REMOTE_ADDR $http_x_forwarded_for;
            fastcgi_param HTTP_X_FORWARDED_FOR $http_x_forwarded_for;
            fastcgi_param HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;

            # NO FastCGI caching - this is an authenticated Laravel app
            # Caching would break CSRF tokens, sessions, and user-specific content
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
        }

        # Deny access to sensitive files (except .well-known for Let's Encrypt, etc.)
        location ~ /\.(?!well-known).* {
            deny all;
            log_not_found off;
        }

        # Long cache for static assets (CSS, JS, images)
        # Laravel's Vite adds hashes to filenames for cache busting
        location ~* \.(jpg|jpeg|gif|png|svg|woff|woff2|ttf|mp4|webp|ico|css|js)$ {
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable" always;
            access_log off;
        }

        # Allow FPM status/ping from localhost only
        location ~ ^/(fpm-status|fpm-ping)$ {
            access_log off;
            allow 127.0.0.1;
            deny all;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;
        }
    }
}
